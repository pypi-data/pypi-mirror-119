#!/usr/bin/env python3
# This file is placed in the Public Domain.

__version__ = 61

import importlib
import pkgutil
import os
import readline
import sys
import termios
import time

from bot.irc import Cfg
from bot.obj import RunCfg, fmt
from bot.run import Runtime, Table, spl

RunCfg.wd = "/var/lib/botd/"


Cfg.channel = "#botd"
Cfg.nick = "botd"
Cfg.username = "botd"
Cfg.realname = "24/7 channel daemon"
Cfg.users = False


class Kernel(Runtime):

    def error(self, txt):
        self.log(txt)

    def log(self, txt):
        print(txt)
        sys.stdout.flush()


class Table(Table):

    def addmod(self, mn):
        spc = importlib.util.find_spec(mn)
        if not spc:
            return
        mod = importlib.import_module(mn)
        self.introspect(mod)

    def scan(self, pn):
        spc = importlib.util.find_spec(pn)
        if not spc:
            return
        pkg = importlib.import_module(pn)
        for mn in pkgutil.walk_packages(pkg.__path__, pn + "."):
            mod = importlib.import_module(mn.name)
            if mod:
                self.introspect(mod)

        
k = Kernel()
tbl = Table()


def cmd(event):
    event.reply(",".join(tbl.modnames))


def ver(event):
    event.reply("BOTD %s" % __version__)

def wrap(func):
    try:
        func()
    except KeyboardInterrupt:
        print("")
    except PermissionError as ex:
        print(ex)


def main(): 
    k.log("BOTD started at %s" % (time.ctime(time.time())))
    k.log(fmt(RunCfg))
    k.log(fmt(k.cfg))
    k.privileges()
    tbl.add(cmd)
    tbl.add(ver)
    k.cfg.mod += ",irc"
    tbl.scan("bot")
    k.start()
    for mn in spl(k.cfg.mod):
        k.init("bot.%s" % mn)
    k.wait()


wrap(main)
