define(["jquery","base/js/keyboard","require","base/js/namespace","notebook/js/cell","notebook/js/codecell","module"],(function(e,t,o,n,s,i,r){"use strict";const c="["+r.id+"]";let a,l=.3,u=3e3,p=5e3,d=530,m={is_open:!1,data:{},last_submission:"",current_choice_idx:void 0,choices:[],considering_choices:!1,suggestion_accept_timeout:void 0,version_is_up_to_date:void 0},g=s.Cell,f=i.CodeCell,h=t.keycodes,_=[h.enter,h.esc,h.backspace,h.tab,h.up,h.down,h.shift,h.ctrl,h.alt,h.meta,h.capslock,h.pageup,h.pagedown,h.end,h.home,h.insert,h.delete,h.numlock,h.f1,h.f2,h.f3,h.f4,h.f5,h.f6,h.f7,h.f8,h.f9,h.f10,h.f11,h.f12,h.f13,h.f14,h.f15];const y=e=>{const t=e.split("\n");if(0===t.length)return[0,0];return[t.length,t.slice(-1)[0].length]},b=(e,t,o)=>{e.code_mirror.options[t]=o},k=(e,t,o,n)=>{let s=e.code_mirror;console.log(c,"Setting opacity from",t,"to",o,"to",n),s.markText(t,o,{css:`opacity:${n}`})},v=e=>{const t=y(e);return{line:t[0]-1,ch:t[1]}};const x=e=>{if(!m.considering_choices)return;const t=e.get_text();b(e,"cursorBlinkRate",d),((e,t)=>{const[o,s]=y(t);n.notebook.get_selected_cell().code_mirror.setCursor(o,s)})(0,t),(e=>{b(e,"readOnly",!1)})(e);const o=v(t);k(e,{line:0,ch:0},o,1),m.considering_choices=!1,F(),m.choices=[]},j=()=>{m.considering_choices=!0,H(),void 0!==m.suggestion_accept_timeout&&clearTimeout(m.suggestion_accept_timeout);let e=m.choices[m.current_choice_idx],t=n.notebook.get_selected_cell();e=(e=>{let t=[],o=e.split("\n");for(let e=0;e<o.length;e++){let n=o[e].trimEnd();n.startsWith("# ")&&(n=n.replace("# ","## "),n.endsWith(" ##")||(n+=" ##")),t.push(n)}return t=t.join("\n"),t})(e);const o=(e=>{let t=e.get_text();const o=t.lastIndexOf("##");return t.slice(0,o+2)})(t),s=`${o}\n\n${e}`;t.set_text(s);const i=v(o+"\n\n"),r=v(s);k(t,i,r,l),(e=>{b(e,"readOnly",!0)})(t),b(t,"cursorBlinkRate",-1),m.suggestion_accept_timeout=setTimeout((()=>{x(t)}),u)};function T(e){const t=document.cookie.match("\\b"+e+"=([^;]*)\\b");return t?t[1]:void 0}const C=t=>{t?e("#cogram-spinner").addClass("fa-spin").css("color","orange"):e("#cogram-spinner").removeClass("fa-spin").css("color","green")},S=()=>{const t=n.notebook.get_selected_index();let o=n.notebook.get_cells().map((e=>e.get_text())).slice(0,t+1),s=o.pop();const i=n.notebook.session.id,r=n.notebook.kernel.id;let l={queries:(e=>{let t=[];const o=e.split("\n");for(let e=0;e<o.length;e++){let n=o[e];""!==n&&n.startsWith("## ")&&(n=n.replace("## ",""),n=n.replace(" #",""),n.endsWith("#")&&(n=n.substring(0,n.length-1),n=n.trim()),t.push(n))}return t})(s),cell_contents:o,session_id:i,kernel_id:r,auth_token:a};const u=T("_xsrf");e.post({url:"/cogram",data:JSON.stringify(l),headers:{"X-XSRFToken":u},dataType:"json",contentType:"application/json",beforeSend:function(e){C(!0)},success:function(e){!function(e,t){m.choices=t.message,m.current_choice_idx=0,console.log(c,"starting insertion of first choice"),j()}(0,e)},error:X,complete:function(){C(!1)}})},w=()=>{console.log(c,"Checking if valid token exists..."),e.get({url:"/token",dataType:"JSON",async:!1,success:function(e){return a=e.auth_token,!0},error:function(e,t,o){return((e,t,o)=>{a=void 0,console.log(c,"`checkValidTokenExists` ajax error:",e,t,o)})(e,t,o),!1}});const t=void 0!==a;return console.log(c,"check completed. success",t),t},O=(e,t,o)=>{let n=JSON.parse(e.responseText);m.version_is_up_to_date=!1,console.log(c,n);let s=n?.pypi_version;n?.installed_version;U(`<div class="mui--text-subhead">A new Jupyter Cogram release is available üéâ \n        <span class="mui--text-body2"><br><br>Please upgrade to version ${s} by running<br><br><span style="font-family:monospace">!python3 -m pip install -U jupyter-cogram</span>\n        <br><br>in a code cell. Afterwards, please restart your Jupyter Notebook server.</span></div>`,2e4)};let $=function(){console.log(c,"Initializing extension..."),n.toolbar.add_buttons_group([n.keyboard_manager.actions.register({help:"Launch jupyter-cogram",icon:"fas fa-link",handler:K},"create-jupyter-cogram-from-notebook","Cogram")],"cogram-button-group");var t,o;e(".fas.fa-link.fa").replaceWith('<img id="cogram-button-logo" src="https://uploads-ssl.webflow.com/61294dc1bd225d7c490b4389/6131d7249979f73249363dd0_icon_black_64.png" style="max-height:16px;"alt="Cogram">'),t=e("<button/>").attr("id","cogram-status").attr("class","btn btn-default").attr("title","Cogram status").attr("style","display: none;"),o=e("<i/>").attr("id","cogram-spinner").attr("style","color: green;").attr("class","fa fa-circle-o-notch"),t.append(o),e("#cogram-button-group").append(t)};const N=t=>{t?(console.log(c,"Extension is off. Turning it on."),e("#cogram-status").show(),m.is_open=!0):(console.log(c,"Extension is on. Turning it off."),e("#cogram-status").hide(),m.is_open=!1)},J=t=>{console.log("Showing panel with content",t),e("#info-panel-content").remove(),e("#jupyter-cogram-info-panel").append(t),e("#jupyter-cogram-info-panel").show()};function K(){if(m.is_open)return void N(!1);const t=w();console.log(c,"Valid token exists:",t),t?(e("#jupyter-cogram-info-panel").hide(),N(!0)):(J(V()),N(!1))}const W=e=>e.get_text().split("\n")[e.code_mirror.getCursor().line],q=e=>{if(""===e.get_text())return!1;const t=W(e);return t.startsWith("## ")&&t.endsWith(" #")},A=e=>{if(""===e.get_text())return!1;const t=W(e);return t.startsWith("## ")&&t.endsWith(" ##")};function E(e){const o=t.inv_keycodes[e.which];return(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)&&("alt"===o||"ctrl"===o||"meta"===o||"shift"===o)}function I(e){return e.ctrlKey||e.metaKey}function P(e){const o=e.keyCode;return o===t.keycodes.left||o===t.keycodes.right}const R=e=>{const o=e.keyCode===t.keycodes.right,n=m.current_choice_idx,s=m.choices.length;if(1===s)return;let i;i=o?n<=s-2?n+1:0:n>0?n-1:s-1,m.current_choice_idx=i};function X(e,t,o){console.log("jupyter_cogram ajax error:",e,t,o);const n=`${JSON.parse(e.responseText).message}`;B(n,1e4)}const B=(t,o=2e3)=>{const n=e("#info-panel-content").html();let s=e("<div class='mui--text-body2 alert-message'>"+t+"</div>");e("#info-panel-content").html(s),D(),o&&setTimeout((()=>{n&&e("#info-panel-content").html(n),e("#jupyter-cogram-info-panel").hide()}),o)},U=(t,o=5e3)=>{const n=e("#info-panel-content").html();let s=e("<div class='mui--text-body2 success-message'>"+t+"</div>");e("#info-panel-content").html(s),D(),o&&setTimeout((()=>{n&&e("#info-panel-content").html(n),e("#jupyter-cogram-info-panel").hide()}),o)},V=()=>{var t=e('<div id="info-panel-content"/>').text("Please submit your API token"),o=e('<form id="token_submit_form"><div class="mui-textfield"><input type="text"name="api_token" placeholder="Your API token" spellcheck="false"class="mui--is-empty mui--is-pristine mui--is-touched"></div><button id="cogram_token_submit" class="mui-btn mui-btn--primary" type="submit">Submit</button></form>');return t.append(o),e("body").on("submit","#token_submit_form",(t=>{t.preventDefault();const o=t.target,[n,s]=(t=>{console.log(c,"Submitting token",t);var o=!1;let n;return e.post({url:"/token",data:JSON.stringify({auth_token:t}),headers:{"X-XSRFToken":T("_xsrf")},dataType:"json",async:!1,contentType:"application/json",success:function(e){a=t,N(!0),o=!0},error:function(e,t,o){let s=JSON.parse(e.responseText);n=`Error ${e.status}: ${s.error}`,console.log("Have error msg from `submitToken()`",n)}}),console.log(c,"Token submission completed. Success?",o),[o,n]})(o?.api_token?.value);n?U("Thanks, your token looks good üéâ",2e3):B(s,5e3)})),t};var z=navigator.platform.toUpperCase().indexOf("MAC")>=0;const F=()=>e("#cogram-hint").remove(),H=()=>{var t,o,n,s;F(),s=z?"‚åò‚èé":"Ctrl+‚èé",t=m.choices.length>1?`Next (‚Üí) &nbsp &nbsp Previous (‚Üê) &nbsp &nbsp Accept (${s})`:`Accept (${s})`,o=e('<div class="mui-panel" id="cogram-hint"/>'),n=e(`<div class="mui--text-body2" id="cogram-hint-text">${t}</div>`),o.append(n),e(".cell.code_cell.selected").prepend(o)},D=()=>e("#jupyter-cogram-info-panel").show(),L=e=>{let t=document.createElement("link");t.type="text/css",t.rel="stylesheet",t.href=o.toUrl(e),document.getElementsByTagName("head")[0].appendChild(t)},M=()=>{w()?(console.log(c,"Checking if version is up to date..."),e.get({url:"/checkVersion",dataType:"JSON",async:!1,success:function(e){m.version_is_up_to_date=!0},error:O})):J(V())};function Y(){var t,o,s;L("//cdn.muicss.com/mui-0.10.3/css/mui.min.css"),L("./jupyter_cogram.css"),t=g.prototype.handle_codemirror_keyevent,g.prototype.handle_codemirror_keyevent=function(e,o){if(!m.is_open)return;const n=-1!==_.indexOf(o.keyCode),s=I(o);if(console.log(c,"Handling keyevent",o.keyCode,"is special?",n,"command plus event?",s),this instanceof f&&!n&&!E(o)&&!s){this.queryTimer&&clearTimeout(this.queryTimer);let e=this;if(m.considering_choices&&P(o))R(o),j();else if(q(e)&&[35,51,220].includes(o.keyCode))S();else if(A(e)){const e=p;console.log(c,`Scheduling query to run in ${e} ms`),this.queryTimer=setTimeout(S,e)}}return t.apply(this,arguments)},function(){let e=f.prototype.execute;f.prototype.execute=function(t){return x(this),e.apply(this,arguments)}}(),o=e("<div/>").attr("id","jupyter-cogram-info-panel").attr("class","cogram_info_panel_display mui-panel mui--text-subhead mui--z2").attr("style","display: none;"),s=e("<div id='cogram_token_close'>x</div>"),o.append(s).append(e('<div id="info-panel-content"/>')),e("body").on("click","#cogram_token_close",(()=>e("#jupyter-cogram-info-panel").hide())),e("body").on("focus","#jupyter-cogram-info-panel",(()=>n.keyboard_manager.disable())),e("body").on("blur","#jupyter-cogram-info-panel",(()=>n.keyboard_manager.enable())),e("#site").prepend(o),n.notebook.kernel?(console.log(c,"Initialising with Kernel ready!"),$(),M()):(console.log(c,"Kernel not ready. Initialising later"),n.notebook.events.one("kernel_ready.Kernel",(()=>{$(),M()})))}return{load_jupyter_extension:Y,load_ipython_extension:Y}}));