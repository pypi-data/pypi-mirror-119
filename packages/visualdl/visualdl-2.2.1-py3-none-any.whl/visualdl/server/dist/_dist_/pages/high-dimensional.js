import*as We from"../../__snowpack__/env.js";import qe,{AsideSection as L}from"../components/Aside.js";import Xe from"../components/HighDimensionalPage/HighDimensionalChart.js";import Ye from"../components/HighDimensionalPage/LabelSearchInput.js";import t,{useCallback as E,useEffect as m,useMemo as l,useRef as ze,useState as a}from"../../__snowpack__/pkg/react.js";import Ge from"../components/BodyLoading.js";import Ke from"../components/Button.js";import Je from"../components/Content.js";import Qe from"../components/HighDimensionalPage/DimensionSwitch.js";import Ze from"../components/Error.js";import i from"../components/Field.js";import et from"../components/HighDimensionalPage/LabelSearchResult.js";import{LabelType as he}from"../resource/high-dimensional/index.js";import tt from"../components/HighDimensionalPage/PCADetail.js";import nt from"../components/HighDimensionalPage/ReductionTab.js";import at from"../components/ScatterChart/ScatterChart.js";import ot from"../components/Select.js";import lt from"../components/HighDimensionalPage/TSNEDetail.js";import st from"../components/Title.js";import rt from"../components/HighDimensionalPage/UMAPDetail.js";import it from"../components/HighDimensionalPage/UploadDialog.js";import ge from"../../__snowpack__/pkg/query-string.js";import{rem as X}from"../utils/style.js";import b from"../../__snowpack__/pkg/styled-components.js";import{toast as Y}from"../../__snowpack__/pkg/react-toastify.js";import z from"../hooks/useRequest.js";import{useTranslation as ct}from"../../__snowpack__/pkg/react-i18next.js";import mt from"../hooks/useWorker.js";const dt=We.MODE,ut={pca:5e4,tsne:1e4,umap:5e3},pt={pca:200,tsne:void 0,umap:void 0},ht=b.div`
    font-size: ${X(16)};
    line-height: ${X(16)};
    font-weight: 700;
    margin-bottom: ${X(20)};
`,G=b(ot)`
    width: 100%;
`,gt=b(Ke)`
    width: 100%;
`,fe=b(qe)`
    .secondary {
        color: var(--text-light-color);
    }
`,ft=b(fe)`
    border-left: 1px solid var(--border-color);
`,Et=b(fe)`
    border-right: 1px solid var(--border-color);

    ${L} {
        border-bottom: none;
    }

    > .aside-top > .search-result {
        margin-top: 0;
        margin-left: 0;
        margin-right: 0;
        flex: auto;
        overflow: hidden auto;
    }
`,bt=b(Je)`
    background-color: var(--background-color);
`,vt=()=>{const{t:o}=ct(["high-dimensional","common"]),v=ze(null),{data:x,loading:Ee}=z("/embedding/list"),C=l(()=>{var e;return(e=x==null?void 0:x.map(n=>({value:n.name,label:n.name,...n})))!=null?e:[]},[x]),[c,K]=a(),g=l(()=>C.find(e=>e.value===c),[C,c]);m(()=>{var e,n;K((n=(e=C[0])==null?void 0:e.value)!=null?n:void 0)},[C]);const{data:w,loading:J}=z(c?`/embedding/tensor?${ge.stringify({name:c})}`:null),{data:A,loading:Q}=z(c?`/embedding/metadata?${ge.stringify({name:c})}`:null),[be,Z]=a(!1),[I,d]=a(!1),[H,f]=a("");m(()=>{I||f("")},[I]),m(()=>{H&&d(!0)},[H]),m(()=>{J&&(d(!0),f("fetching-tensor"))},[J]),m(()=>{Q&&(d(!0),f("fetching-metadata"))},[Q]);const[j,ee]=a(null),[te,ne]=a(null),ve=E(e=>{ee(e),ne(null)},[]),[F,Ce]=a(""),[ae,_e]=a(""),[De,Se]=a(new Float32Array),[_,ye]=a([]),T=l(()=>_.map(({label:e},n)=>({label:e,value:n})),[_]),[M,oe]=a(0),le=l(()=>[{label:o("high-dimensional:no-color-map"),value:-1},..._.map((e,n)=>({label:e.label,value:n,disabled:e.type===he.Null||e.type===he.Category&&e.categories.length>at.CATEGORY_COLOR_MAP.length}))],[_,o]),[D,se]=a(-1),[S,Re]=a([]),[O,je]=a(0),[Pe,Le]=a([0,0]),xe=l(()=>S[M],[M,S]),Ae=l(()=>D===-1?null:{..._[D],labels:S[D]},[D,_,S]),[y,Te]=a("3d"),[u,Me]=a("pca"),B=l(()=>y==="3d",[y]),N=E((e,n,h)=>{if(n){d(!0),f(e);const s=new FileReader;s.readAsText(n,"utf-8"),s.onload=()=>{h(k=>{const P=s.result;return k===P&&d(!1),P})}}else h("")},[]);m(()=>N("reading-vector",j,Ce),[j,N]),m(()=>N("reading-metadata",te,_e),[te,N]),m(()=>ee(null),[c]);const V=E(e=>{Y(e.message,{position:Y.POSITION.TOP_CENTER,type:Y.TYPE.ERROR}),dt!=="production"&&console.error(e),d(!1)},[]),Ne=l(()=>{const e={maxCount:ut[u],maxDimension:pt[u]};return F?{from:"string",params:{vectors:F,metadata:ae,...e}}:g&&w?{from:"blob",params:{shape:g.shape,vectors:w.data,metadata:A!=null?A:"",...e}}:null},[u,F,g,w,ae,A]),re=mt("high-dimensional/parse-data",Ne);m(()=>{const{error:e,data:n}=re;e?V(e):n?(Le(n.rawShape),je(n.dimension),Se(n.vectors),ye(n.labels),oe(0),se(-1),Re(n.metadata)):n!==null?f("parsing"):(d(!1),f(""))},[re,V]);const ie=l(()=>O!==0,[O]),U=l(()=>{var e;return j?j.name:(e=g==null?void 0:g.path)!=null?e:""},[j,g]),[$,ke]=a(5),[W,we]=a(10),[q,Ie]=a(15),ce=E(e=>{var n;Ie(e),(n=v.current)==null||n.rerunUMAP()},[]),[r,me]=a(),He=E(()=>{me(void 0),f("calculating")},[]),Fe=E(e=>{me(e),d(!1)},[]),[p,Oe]=a({labelIndex:void 0,value:""}),R=l(()=>{if(p.labelIndex==null||p.value==="")return{indices:[],metadata:[]};const e=S[p.labelIndex],n=[],h=[];for(let s=0;s<e.length;s++)e[s].includes(p.value)&&(n.push(e[s]),h.push(s));return{indices:h,metadata:n}},[S,p.labelIndex,p.value]),[Be,Ve]=a([]),de=E(e=>Ve(e==null?[]:[R.indices[e]]),[R.indices]),ue=l(()=>{var e,n,h,s,k,P,pe;switch(u){case"pca":return t.createElement(tt,{dimension:y,variance:(e=r==null?void 0:r.variance)!=null?e:[],totalVariance:(n=r==null?void 0:r.totalVariance)!=null?n:0});case"tsne":return t.createElement(lt,{iteration:(h=r==null?void 0:r.step)!=null?h:0,perplexity:$,learningRate:W,is3D:B,onChangePerplexity:ke,onChangeLearningRate:we,onPause:(s=v.current)==null?void 0:s.pauseTSNE,onResume:(k=v.current)==null?void 0:k.resumeTSNE,onStop:(P=v.current)==null?void 0:P.pauseTSNE,onRerun:(pe=v.current)==null?void 0:pe.rerunTSNE});case"umap":return t.createElement(rt,{neighbors:q,onRun:ce});default:return null}},[u,y,r,$,W,B,q,ce]),Ue=l(()=>t.createElement(ft,null,t.createElement(L,null,t.createElement(ht,null,o("high-dimensional:data")),t.createElement(i,{label:o("high-dimensional:select-data")},t.createElement(G,{list:C,value:c,onChange:K})),t.createElement(i,{label:o("high-dimensional:select-label")},t.createElement(G,{list:T,value:M,onChange:oe})),t.createElement(i,{label:o("high-dimensional:select-color")},t.createElement(G,{list:le,value:D,onChange:se})),t.createElement(i,null,t.createElement(gt,{rounded:!0,outline:!0,type:"primary",onClick:()=>Z(!0)},o("high-dimensional:upload-data"))),t.createElement(i,null,U&&t.createElement("div",{className:"secondary"},o("high-dimensional:data-path"),o("common:colon"),U))),t.createElement(L,null,t.createElement(i,null,t.createElement(nt,{value:u,onChange:Me})),t.createElement(i,{label:o("high-dimensional:dimension")},t.createElement(Qe,{value:y,onChange:Te})),ue)),[o,C,c,T,M,le,D,U,u,y,ue]),$e=l(()=>t.createElement(Et,null,t.createElement(L,null,t.createElement(i,null,t.createElement(Ye,{labels:T,onChange:Oe})),p.value!==""&&t.createElement(i,{className:"secondary"},t.createElement("span",null,o("high-dimensional:matched-result-count",{count:R.metadata.length})))),t.createElement(L,{className:"search-result"},t.createElement(i,null,t.createElement(et,{list:R.metadata,onHovered:de})))),[de,T,p.value,R.metadata,o]);return t.createElement(t.Fragment,null,t.createElement(st,null,o("common:high-dimensional")),I||Ee?t.createElement(Ge,null,o(`high-dimensional:loading.${H}`)):null,t.createElement(bt,{aside:Ue,leftAside:$e},ie?t.createElement(Xe,{ref:v,vectors:De,labels:xe,colorMap:Ae,shape:Pe,dim:O,is3D:B,reduction:u,perplexity:$,learningRate:W,neighbors:q,focusedIndices:Be,highlightIndices:R.indices,onCalculate:He,onCalculated:Fe,onError:V}):t.createElement(Ze,null),t.createElement(it,{open:be,hasVector:ie,onClose:()=>Z(!1),onChangeVectorFile:ve,onChangeMetadataFile:ne})))};export default vt;
