import{actions as x,selectors as D}from"../store/index.js";import{color as T,colorAlt as E}from"../utils/chart.js";import{useCallback as w,useEffect as _,useMemo as g,useReducer as Q}from"../../__snowpack__/pkg/react.js";import{useDispatch as F,useSelector as G}from"../../__snowpack__/pkg/react-redux.js";import{cache as I}from"../../__snowpack__/pkg/swr.js";import M from"../../__snowpack__/pkg/lodash/groupBy.js";import O from"../../__snowpack__/pkg/lodash/intersection.js";import P from"../../__snowpack__/pkg/lodash/intersectionBy.js";import W from"../../__snowpack__/pkg/lodash/uniq.js";import v from"./useQuery.js";import{useRunningRequest as z}from"./useRequest.js";var S;(function(s){s[s.initRuns=0]="initRuns",s[s.setRuns=1]="setRuns",s[s.setSelectedRuns=2]="setSelectedRuns",s[s.initTags=3]="initTags",s[s.setTags=4]="setTags",s[s.setSelectedTags=5]="setSelectedTags"})(S||(S={}));const b=(s,l)=>Object.entries(M(s.filter(e=>!!s.find(n=>n.label===e.label)).reduce((e,n)=>(l&&l[n.label]&&Array.prototype.push.apply(e,l[n.label].map(r=>({label:r,run:n}))),e),[]),e=>e.label)).map(([e,n])=>({label:e,runs:n.map(r=>r.run)})),H=s=>s==null?void 0:s.map((l,e)=>{const n=e%T.length;return{label:l,colors:[T[n],E[n]]}}),J=(s,l)=>{switch(l.type){case 0:{const e=l.payload,n=e.length?O(e,s.globalRuns):s.globalRuns,r=n.length?n:e,u=H(e),i=u.filter(h=>r.includes(h.label)),f=b(i,s.initTags);return{...s,initRuns:e,globalRuns:r,runs:u,selectedRuns:i,tags:f,selectedTags:f}}case 1:{const e=l.payload,n=P(s.selectedRuns,e,u=>u.label),r=b(n,s.initTags);return{...s,runs:e,selectedRuns:n,tags:r,selectedTags:r}}case 2:{const e=l.payload,n=e.map(u=>u.label),r=b(e,s.initTags);return{...s,globalRuns:n,selectedRuns:e,tags:r,selectedTags:r}}case 3:{const e=l.payload,n=b(s.selectedRuns,e);return{...s,initTags:e,tags:n,selectedTags:n}}case 4:{const e=l.payload;return{...s,tags:e,selectedTags:e}}case 5:{const e=l.payload;return{...s,selectedTags:e}}default:throw new Error}},K=(s,l)=>{const e=v(),{data:n,loading:r,error:u}=z(`/${s}/tags`,l);_(()=>()=>I.delete(`/${s}/tags`),[s]);const i=F(),f=g(()=>D.runs.getRunsByPage(s),[s]),h=G(f),m=g(()=>{var t;return(t=n==null?void 0:n.runs)!=null?t:[]},[n]),c=g(()=>n?m.reduce((t,o,p)=>{var R,k,j;return t[o]?t[o]=[...t[o],...(k=(R=n.tags)==null?void 0:R[p])!=null?k:[]]:t[o]=(j=n.tags[p])!=null?j:[],t},{}):{},[m,n]),[a,d]=Q(J,{initRuns:[],globalRuns:h,runs:[],selectedRuns:[],initTags:{},tags:[],selectedTags:[]}),y=g(()=>e.runs?W(Array.isArray(e.runs)?e.runs:e.runs.split(",")):[],[e]),q=w(t=>d({type:2,payload:t}),[]),B=w(t=>d({type:5,payload:t}),[]);_(()=>d({type:0,payload:m||[]}),[m]),_(()=>d({type:3,payload:c||{}}),[c]),_(()=>{if(y.length){const t=a.runs.filter(o=>y.includes(o.label));d({type:2,payload:t.length?t:a.runs})}},[y,a.runs]),_(()=>{i(x.runs.setSelectedRuns(s,a.globalRuns))},[i,a.globalRuns,s]);const C=g(()=>a.tags.reduce((t,{runs:o,...p})=>(Array.prototype.push.apply(t,o.map(R=>({...p,run:R,id:`${p.label}-${R.label}`}))),t),[]),[a.tags]),$=g(()=>a.selectedRuns.filter(t=>{var o;return!!((o=c==null?void 0:c[t.label])==null?void 0:o.length)}),[a.selectedRuns,c]);return{...a,tagsWithSingleRun:C,runsInTags:$,onChangeRuns:q,onChangeTags:B,loading:r,error:u}};export default K;
